<!-- clueless/templates/clueless/index.html -->
{% extends 'clueless/base.html' %}
{% load static %}

{% block content %}

<!-- Main Content -->
  <div class="drawer drawer-end">
    <input id="detective-notebook" type="checkbox" class="drawer-toggle" />
    <div id="control-container" class="container mx-auto drawer-content">
      <button class="btn btn-primary" onclick="player_suggestion.showModal()">Make a Suggestion</button>
      <button id="accuse_button" class="btn btn-primary" onclick="player_accusation.showModal()">Make an Accusation</button>
      <button class="btn btn-primary" onclick="card_carousel.showModal()">View Your Cards</button>
      <button onclick="toggleNotebook()" class="btn btn-primary">Toggle Detective Notebook</button>
      <button class="btn btn-primary" id="end-turn" class="btn btn-error" disabled>End Turn</button>
      <div class="grid grid-cols-3">
        <div id="board-container" class="col-auto col-span-2">
          <div id="board-prompt" class="label">
            <span class="text-xl">
                Click on a location to move
            </span>
          </div>
          <div id="game-board" class="grid grid-rows-5 grid-flow-col align-items gap-5 font-mono text-white text-sm text-center font-bold leading-6 rounded-lg">
            {% for row in locations %}
              {% for location in row %}
                {% if location.location_id in blank_ids %}
                  <div id="{{ location.location_id }}_card" class="card rounded-lg opacity-50 ">
                    <div class="card-body" id="{{ location.location_id }}">
                      <h2 class="card-title">{{ location.name }}</h2>
                    </div>
                  </div>
                {% elif location.location_id in hallway_ids  %}
                  <div id="{{ location.location_id }}_card" class="card rounded-lg bg-gray-500 opacity-55 inline items-center" role="button">
                    <div class="card-body" id="{{ location.location_id }}">
                      <h2 class="card-title">{{ location.name }}</h2>
                    </div>
                  </div>
                {% else %}
                  <div id="{{ location.location_id }}_card" class="card rounded-lg bg-blue-500 opacity-55 inline items-center" role="button">
                    <div class="card-body" id="{{ location.location_id }}">
                      <h2 class="card-title">{{ location.name }}</h2>
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            {% endfor %}
          </div>
        </div>
        <div class="col-autocol-span-1">
          <div id="player-log" class="container mx-auto overflow-auto">
            <div id="selected-character" class="label">
              <span class="text"> Selected Character: </span>
              <span id="selected-character-name" class="text"> </span>
            </div>
            <div class="label">
              <span class="text-xl"> Game Log </span>
            </div>
            <!-- Render game log messages from javascript -->
          </div>
        </div>
      </div>
    </div>

    <!-- Need pointer-events:none to prevent invisible sidebar overlay from preventing click-through -->
    <div id="drawer-overlay" class="drawer-side" style="pointer-events: none;">
      <!-- Need pointer-events:auto to override pointer-events:none and allow sidebar clicks -->
      <div id="notebook-list" class="menu bg-base-200 text-base-content min-h-full w-min p-4" style="pointer-events: auto;">
        <button onclick="toggleNotebook()" class="btn btn-primary"><a>Close Notebook</a></button>
        <h2><strong>Characters</strong></h2>
        <ul>
          {% for character in characters %}
            <li>
              <label class="checkbox-inline">
                <input type="checkbox">{{ character.name }}
              </label>
            </li>
          {% endfor %}
        </ul>
        <h2><strong>Weapons</strong></h2>
        <ul>
          {% for weapon in weapons %}
            <li>
              <label class="checkbox-inline">
                <input type="checkbox">{{ weapon.name }}
              </label>
            </li>
          {% endfor %}
        </ul>
        <h2><strong>Locations</strong></h2>
        <ul>
          {% for room in rooms %}
            <li>
              <label class="checkbox-inline">
                <input type="checkbox">{{ room.name }}
              </label>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Player suggestion modal -->

  <dialog id="player_suggestion" class="modal">
    <div class="modal-box">
      <h3 class="text-lg font-bold">Make a Suggestion</h3>
        <form method="dialog">
            {% csrf_token %} 
          {{ player_action_form }}
          <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
          <button class="btn btn-primary" id="submit_suggest">Submit</button>
        </form>
    </div>
  </dialog>

  <!-- Player accusation modal -->
    <dialog id="player_accusation" class="modal">
        <div class="modal-box">
        <h3 class="text-lg font-bold">Make an Accusation</h3>
            <form method="dialog">
                {% csrf_token %} 
            {{ player_action_form }}
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            <button class="btn btn-primary" id="submit_accuse">Submit</button>
            </form>
        </div>
    </dialog>

  <!-- Disprove suggestion modal -->
   <dialog id="disprove_suggestion" class="modal">
    <div class="modal-box">
      <h3 class="text-lg font-bold">Disprove Suggestion</h3>
        <form method="dialog">
            {% csrf_token %} 
          {{ disprove_form }}
          <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
          <button class="btn btn-primary" id="submit_disprove">Submit</button>
        </form>
    </div>
    </dialog>

    <!-- Card Carousel Modal -->
     <dialog id="card_carousel" class="modal">
        <div class="modal-box">
        <h3 class="text-lg font-bold">Your Cards</h3>
            <div class="carousel carousel-end rounded-box">
            {% for card in player_cards %}
                <div class="carousel-item">
                <img src="{% static 'clueless/images/'|add:card.image %}" alt="{{card.name}}" width="250" height="350"/>
                </div>
            {% endfor %}
            
          </div>
            <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
        </div>

    </dialog>

  {% endblock %}
  
  {% block script %}

<script>
    // track if locations disabled; only run re-enable loop if needed
    let disabledLocations = false;

    // Game Session Websocket
    const activitySocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/clueless/gameroom/'
    );

    activitySocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    }

    // Handle end turn button

    document.querySelector('#end-turn').onclick = function(e) {
        const charID = window.location.href.split('/').pop();
        activitySocket.send(JSON.stringify({
            'message': "End Turn",
            'subtype': 'end_turn',
            'char_id': charID
        }));
        // Disable "End Turn" button
        const endTurnButton = document.querySelector('#end-turn');
        endTurnButton.disabled = true;
        
        // Re-enable all location buttons
        enableAllMoves();
    };

    // Get player locations once page is loaded

    window.onload = function() {
        activitySocket.send(JSON.stringify({
            'message': "Get player locations",
            'subtype': 'character_locations',
        }));
    };
    
    // Resize game board and player log
    
    function resizeBoard() {
        // set gameboard and chat log heights
        let emptyHeight = window.innerHeight;
        emptyHeight -= document.getElementById("navbar").clientHeight;
        emptyHeight -= document.getElementById("end-turn").clientHeight;
        emptyHeight -= document.getElementById("board-prompt").clientHeight;
        const boardContainer = document.getElementById("game-board");
        boardContainer.style.height = emptyHeight + "px";
        const playerLog = document.getElementById("player-log");
        playerLog.style.height = emptyHeight + "px";

        let controlContainer = document.getElementById("control-container");
        let windowWidth = window.innerWidth;
        if (document.getElementById("detective-notebook").checked) {
            // adjust width if notebook is open
            controlContainer.style.marginRight = document.getElementById("notebook-list").clientWidth + "px";
            controlContainer.classList.add("pl-4");
            windowWidth -= document.getElementById("notebook-list").clientWidth;
            controlContainer.style.width = windowWidth + "px";
        } else {
            // remove adjustments if notebook is closed
            controlContainer.style.marginRight = "";
            controlContainer.classList.remove("pl-4");
            controlContainer.style.width = windowWidth + "px";
        }
        // set gameboard and chat log widths
        windowWidth = document.getElementById("control-container").clientWidth;
        boardContainer.style.width = Math.trunc(windowWidth * .66) + "px"
        playerLog.style.width = Math.trunc(windowWidth * .33) + "px";
        let childElementWidth = Math.trunc((windowWidth * .66 - 80) / 5); // 80 is the fixed total padding per row
        // set widths for each location
        let boardContainerChildren = boardContainer.children;
        for (let i = 0; i < boardContainerChildren.length; i++) {
            boardContainerChildren[i].style.width = childElementWidth + "px";
        }
    }
    
    window.onload = resizeBoard;
    window.onresize = resizeBoard;

    // toggles detective notebook and resizes

    function toggleNotebook() {
        let notebook = document.getElementById("detective-notebook"); // get invisible toggle
        notebook.checked = !notebook.checked; // adjust toggle
        resizeBoard();
    }

    // disables all invalid locations

    function disableInvalidMoves(valid_moves) {
        disabledLocations = true;
        // loop through all location elements
        const boardContainer = document.getElementById("game-board");
        let boardContainerChildren = boardContainer.children;
        for (let i = 0; i < boardContainerChildren.length; i++) {
            if (valid_moves.includes(boardContainerChildren[i].id.replace("_card", ""))) {
                // valid move; emphasize element
                boardContainerChildren[i].style.borderWidth = "10px";
                boardContainerChildren[i].style.borderColor = "yellow";
                boardContainerChildren[i].classList.remove("opacity-55")
                boardContainerChildren[i].classList.add("opacity-85")
            } else {
                // invalid move; disable and de-emphasize element and children
                boardContainerChildren[i].disabled = true; // disable card
                boardContainerChildren[i].classList.remove("opacity-55")
                boardContainerChildren[i].classList.add("opacity-25")
                let child_element = boardContainerChildren[i].children[0];
                child_element.disabled = true; // disable card body
                child_element = child_element.children[0];
                child_element.disabled = true; // disable title
            }
        }
    }

    // reverts disableInvalidMoves changes

    function enableAllMoves() {
        const boardContainer = document.getElementById("game-board");
        // loop through all location elements
        let boardContainerChildren = boardContainer.children;
        for (let i = 0; i < boardContainerChildren.length; i++) {
            if (boardContainerChildren[i].disabled) {
                boardContainerChildren[i].disabled = false; // enable card
                let child_element = boardContainerChildren[i].children[0];
                child_element.disabled = false; // enable card-body
                child_element = child_element.children[0];
                child_element.disabled = false; // enable title
                boardContainerChildren[i].classList.remove("opacity-25")
                boardContainerChildren[i].classList.add("opacity-55")
            } else {
                boardContainerChildren[i].classList.remove("opacity-85")
                boardContainerChildren[i].classList.add("opacity-55")
                boardContainerChildren[i].style.borderWidth = "";
                boardContainerChildren[i].style.borderColor = "";
            }
        }
        disabledLocations = false;
    }
    
    // Log messages from the game session

    activitySocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const playerLog = document.querySelector('#player-log');
        if (data.success === false) {
            playerLog.innerHTML += '<div class="chat chat-end"><div class="chat-bubble-error">' + data.message + '</div></div>';
        } else if (data.success === true) {
            playerLog.innerHTML += '<div class="chat chat-end"><div class="chat-bubble-success">' + data.message + '</div></div>';
        } else if (data.message == "game_over") {
            playerLog.innerHTML += '<div class="chat chat-end"><div class="chat-bubble">' + data.message_text + '</div></div>';
            // redirect to end game page
            window.location.href = '/clueless/game_end/' + data.winner;
        } else if (data.message == "character_locations") {

            const charLocIcons = data.char_loc_icons;
            console.log(charLocIcons);
            
            for (const [charID, charLocData] of Object.entries(charLocIcons)) {
                const charLocation = charLocData[0];
                const charIconPath = charLocData[1];
                const charIconID = charID + "-icon";
                // remove icon from previous location
                const prevCharIcon = document.getElementById(charIconID);
                if (prevCharIcon && prevCharIcon.parentElement.id !== charLocation) {
                    // remove icon from previous location
                    prevCharIcon.parentElement.removeChild(prevCharIcon);
                }
                // avoid adding icon if it is already in the location
                else if (prevCharIcon && prevCharIcon.parentElement.id === charLocation) {
                    continue;
                }

                const charLocationElement = document.getElementById(charLocation);
                if (charLocationElement !== null) {
                    const charIcon = document.createElement('img');
                    charIcon.src = "/static/clueless/images/" + charIconPath;
                    charIcon.width = 50;
                    charIcon.height = 50;
                    charIcon.id = charID + "-icon";
                    charLocationElement.appendChild(charIcon);
                } else {
                    console.error('Element with ID ' + charLocation + ' not found.');
                }

                if (disabledLocations) {
                    // re-enable all locations if player selects a valid move
                    enableAllMoves();
                }
                
            };

            // for each char_id and location_id pair, add the character icon to the location, remove from previous location if different
            
        } else {
            playerLog.innerHTML += '<div class="chat chat-end"><div class="chat-bubble">' + data.message + '</div></div>';
        }
        playerLog.scrollTop = playerLog.scrollHeight;
    };

    // Register player turn for any location on the game board

    document.querySelector('#game-board').onclick = function(e) {
        console.log("Clicked " + e.target.id);
        
        if (e.target.disabled) {
            return;
        }
        
        var location = e.target.id;
        // if clicked on card, get child element
        if (e.target.id.includes('_card')) {
            location = e.target.children[0].id;
        }
        // get char id from url path
        const charID = window.location.href.split('/').pop();

        activitySocket.send(JSON.stringify({
            'message': "Selected " + location,
            'char_id': charID,
            'location_id': location,
            'subtype': 'player_move',
            "type": "status.update"
        }));
    };



    // User Session Websocket

    const currentCharID = window.location.href.split('/').pop(); 
   
    const playerActivitySocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/clueless/usersession/'
        + window.location.href.split('/').pop()
    );

    playerActivitySocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    }

    playerActivitySocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const playerLog = document.querySelector('#player-log');

        // show card select popup if disprove suggestion message
        if (data.message === 'disprove_suggestion') {
            const disproveSuggestionModal = document.querySelector('#disprove_suggestion');
            const actor = data.actor;
            const disproveSuggestionForm = document.querySelector('#disprove_suggestion form');
            // set actor name in form
            disproveSuggestionForm.actor.value = actor;
            disproveSuggestionModal.showModal();
        } else {
            playerLog.innerHTML += '<div class="chat chat-end"><div class="chat-bubble chat-bubble-primary">' + data.message + '</div><div class="chat-footer opacity-50">Private</div></div>';
            playerLog.scrollTop = playerLog.scrollHeight;
        }
        if ("accusation_fail" in data) {
            // Disable "Make Accusation" button
            const accusationButton = document.querySelector('#accuse_button');
            accusationButton.disabled = true;
        }
        if ("unlock_turn" in data) {
            // Enable "End Turn" button
            const endTurnButton = document.querySelector('#end-turn');
            endTurnButton.disabled = false;
        }
        if ("move_fail" in data) {
            disableInvalidMoves(data["valid_locations"]);
        }
        if ("welcome_message" in data) {
            let characterLabel = document.getElementById("selected-character-name");
            characterLabel.innerText = data["char_name"];
        }
    };

    // Handle form submission for player suggestion

    document.querySelector('#submit_suggest').onclick = function(e) {
        e.preventDefault();
        const suggestionModal = document.querySelector('#player_suggestion');
        const suggestionForm = document.querySelector('#player_suggestion form');
        const formData = new FormData(suggestionForm);
        const charID = window.location.href.split('/').pop();
        formData.append('char_id', charID);
        activitySocket.send(JSON.stringify({
            'message': "Made a suggestion",
            'char_id': charID,
            'subtype': 'player_suggestion',
            'data': Object.fromEntries(formData)
        }));
        suggestionForm.reset();
        suggestionModal.close();
    };

    // Handle disprove form suggestion
    document.querySelector("#submit_disprove").onclick = function(e) {
        e.preventDefault();
        const disproveSuggestionModal = document.querySelector('#disprove_suggestion');
        const disproveForm = document.querySelector('#disprove_suggestion form');
        const formData = new FormData(disproveForm);
        const charID = window.location.href.split('/').pop();
        formData.append('char_id', charID);
        activitySocket.send(JSON.stringify({
            'message': "Disproved suggestion",
            'type': 'status.update',
            'char_id': charID,
            'subtype': 'disprove_suggestion',
            'data': Object.fromEntries(formData)
        }));
        disproveForm.reset();
        disproveSuggestionModal.close();
    }

    // Handle form submission for player accusation
    
    document.querySelector('#submit_accuse').onclick = function(e) {
        e.preventDefault();
        const suggestionModal = document.querySelector('#player_accusation');
        const suggestionForm = document.querySelector('#player_accusation form');
        const formData = new FormData(suggestionForm);
        const charID = window.location.href.split('/').pop();
        formData.append('char_id', charID);
        activitySocket.send(JSON.stringify({
            'message': "Made an accusation",
            'char_id': charID,
            'subtype': 'player_accusation',
            'data': Object.fromEntries(formData)
        }));
        suggestionForm.reset();
        suggestionModal.close();
    };

    // Handle sending a message to game log
    
    function processMessage() {
        const charID = window.location.href.split('/').pop();
        const messageToSend = charID + ': ' + document.getElementById("a_message").value;
        activitySocket.send(JSON.stringify({
                'message': messageToSend,
                'subtype': 'send_message'
        }));
        document.getElementById('messageForm').reset();
    };

</script>

{% endblock %}
        